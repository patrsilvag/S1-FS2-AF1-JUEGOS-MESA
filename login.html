<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Iniciar sesi√≥n</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<style>
			body {
				background: #f7f7fb;
			}
			.card {
				border-radius: 1rem;
			}
		</style>
	</head>
	<body>
		<div class="container py-5">
			<div class="row justify-content-center">
				<div class="col-12 col-sm-10 col-md-8 col-lg-5">
					<div class="card shadow-sm">
						<div class="card-body p-4 p-lg-5">
							<h1 class="h4 mb-3 text-center">Iniciar sesi√≥n</h1>

							<!-- Alert accesible -->
							<div
								id="login-alert"
								class="alert alert-danger d-none"
								role="alert"
								aria-live="assertive"
							></div>

							<form id="loginForm" novalidate>
								<div class="mb-3">
									<label for="email" class="form-label"
										>Correo electr√≥nico</label
									>
									<input
										type="email"
										class="form-control"
										id="email"
										name="email"
										required
										autocomplete="username"
									/>
									<div class="invalid-feedback">Ingresa un correo v√°lido.</div>
								</div>

								<div class="mb-3">
									<label for="password" class="form-label">Contrase√±a</label>
									<div class="input-group">
										<input
											type="password"
											class="form-control"
											id="password"
											name="password"
											required
											autocomplete="current-password"
										/>
										<button
											class="btn btn-outline-secondary"
											type="button"
											id="togglePass"
											aria-label="Mostrar u ocultar contrase√±a"
										>
											üëÅÔ∏è
										</button>
										<div class="invalid-feedback">Ingresa tu contrase√±a.</div>
									</div>
								</div>

								<div
									class="d-flex justify-content-between align-items-center mb-3"
								>
									<div class="form-check">
										<input
											class="form-check-input"
											type="checkbox"
											value=""
											id="recordarme"
										/>
										<label class="form-check-label" for="recordarme"
											>Recordarme</label
										>
									</div>
									<a href="recuperar.html" class="small"
										>¬øOlvidaste tu contrase√±a?</a
									>
								</div>

								<button
									id="btnLogin"
									type="submit"
									class="btn btn-primary w-100"
								>
									Ingresar
								</button>

								<div class="text-center mt-3">
									<span class="text-muted">¬øNo tienes cuenta?</span>
									<a href="registro.html">Crear cuenta</a>
								</div>
							</form>
						</div>
					</div>

					<p class="text-center text-muted mt-4 mb-0 small">
						Demo educativa con <code>localStorage</code>. No usar en producci√≥n.
					</p>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

		<!-- L√≥gica de login -->
		<script type="module">
			import {
				findUserByEmail,
				setCurrentUser,
				sha256,
			} from "./js/auth.repo.js";

			const form = document.getElementById("loginForm");
			const alertBox = document.getElementById("login-alert");
			const btn = document.getElementById("btnLogin");
			const emailEl = document.getElementById("email");
			const passEl = document.getElementById("password");
			const togglePass = document.getElementById("togglePass");

			// Mostrar/ocultar contrase√±a
			togglePass.addEventListener("click", () => {
				const isPwd = passEl.getAttribute("type") === "password";
				passEl.setAttribute("type", isPwd ? "text" : "password");
				togglePass.textContent = isPwd ? "üôà" : "üëÅÔ∏è";
			});

			function showError(msg) {
				alertBox.textContent = msg;
				alertBox.classList.remove("d-none");
				setTimeout(() => alertBox.classList.add("d-none"), 3000);
			}
			function setInvalid(el, msg) {
				el.classList.add("is-invalid");
				const fb =
					el.parentElement.querySelector(".invalid-feedback") ||
					el.nextElementSibling;
				if (fb) fb.textContent = msg || fb.textContent;
			}
			function clearInvalid(...els) {
				els.forEach((el) => el.classList.remove("is-invalid"));
			}

			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				btn.disabled = true;
				alertBox.classList.add("d-none");
				clearInvalid(emailEl, passEl);

				const email = (emailEl.value || "").trim();
				const password = passEl.value || "";

				// Validaciones m√≠nimas de formulario
				let ok = true;
				if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
					setInvalid(emailEl, "Ingresa un correo v√°lido.");
					ok = false;
				}
				if (!password) {
					setInvalid(passEl, "Ingresa tu contrase√±a.");
					ok = false;
				}
				if (!ok) {
					btn.disabled = false;
					return;
				}

				try {
					const user = findUserByEmail(email);
					if (!user) {
						showError("Usuario o contrase√±a inv√°lidos.");
						setInvalid(emailEl);
						setInvalid(passEl);
						btn.disabled = false;
						return;
					}

					const hash = await sha256(password);
					if (hash !== user.passwordHash) {
						showError("Usuario o contrase√±a inv√°lidos.");
						setInvalid(passEl);
						btn.disabled = false;
						return;
					}

					// Persistir sesi√≥n
					setCurrentUser(user);

					// "Recordarme": si quieres algo extra (p. ej., timestamp), puedes guardarlo aqu√≠
					if (document.getElementById("recordarme").checked) {
						// opcional: localStorage.setItem('remember', '1');
					}

					// Redirige a tu home
					window.location.href = "index.html";
				} catch (err) {
					console.error(err);
					showError("Ocurri√≥ un error al iniciar sesi√≥n.");
					btn.disabled = false;
				}
			});
		</script>
	</body>
</html>
