<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Iniciar sesi√≥n</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<style>
			body {
				background: #f7f7fb;
			}
			.card {
				border-radius: 1rem;
			}
		</style>
	</head>
	<body>
		<!-- Header reutilizable -->
		<div id="header-placeholder"></div>

		<main class="container py-5" style="min-height: 60vh">
			<div class="row justify-content-center">
				<div class="col-12 col-sm-10 col-md-8 col-lg-5">
					<div class="card shadow-sm">
						<div class="card-body p-4 p-lg-5">
							<h1 class="h4 mb-3 text-center">Iniciar sesi√≥n</h1>

							<!-- Alert accesible -->
							<div
								id="login-alert"
								class="alert d-none"
								role="alert"
								aria-live="assertive"
							></div>

							<form id="loginForm" novalidate>
								<div class="mb-3">
									<label for="email" class="form-label"
										>Correo electr√≥nico</label
									>
									<input
										type="email"
										class="form-control"
										id="email"
										name="email"
										required
										autocomplete="username"
										aria-describedby="error-email"
									/>
									<small
										id="error-email"
										class="text-danger d-block"
										style="display: none"
									></small>
								</div>

								<div class="mb-3">
									<label for="password" class="form-label">Contrase√±a</label>
									<div class="input-group">
										<input
											type="password"
											class="form-control"
											id="password"
											name="password"
											required
											autocomplete="current-password"
											aria-describedby="error-password"
										/>
										<button
											class="btn btn-outline-secondary"
											type="button"
											id="togglePass"
											aria-label="Mostrar u ocultar contrase√±a"
										>
											üëÅÔ∏è
										</button>
									</div>
									<small
										id="error-password"
										class="text-danger d-block"
										style="display: none"
									></small>
								</div>

								<div
									class="d-flex justify-content-between align-items-center mb-3"
								>
									<div class="form-check">
										<input
											class="form-check-input"
											type="checkbox"
											value=""
											id="recordarme"
										/>
										<label class="form-check-label" for="recordarme"
											>Recordarme</label
										>
									</div>
									<a href="recuperar.html" class="small"
										>¬øOlvidaste tu contrase√±a?</a
									>
								</div>

								<button
									id="btnLogin"
									type="submit"
									class="btn btn-primary w-100"
								>
									Ingresar
								</button>

								<div class="text-center mt-3">
									<span class="text-muted">¬øNo tienes cuenta?</span>
									<a href="registro.html">Crear cuenta</a>
								</div>
							</form>
						</div>
					</div>

					<p class="text-center text-muted mt-4 mb-0 small">
						Demo educativa con <code>localStorage</code>. No usar en producci√≥n.
					</p>
				</div>
			</div>
		</main>

		<!-- Footer reutilizable -->
		<div id="footer-placeholder"></div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="./js/site.js"></script>

		<!-- L√≥gica de login reutilizando validaciones.js -->
		<script type="module">
			import { emailValido, setFeedback } from "./js/validaciones.js";
			import {
				findUserByEmail,
				setCurrentUser,
				sha256,
			} from "./js/auth.repo.js";

			const form = document.getElementById("loginForm");
			const alertBox = document.getElementById("login-alert");
			const btn = document.getElementById("btnLogin");
			const emailEl = document.getElementById("email");
			const passEl = document.getElementById("password");
			const togglePass = document.getElementById("togglePass");

			function showAlert(msg, type = "danger", ms = 3000) {
				alertBox.className = "alert alert-" + type;
				alertBox.textContent = msg;
				alertBox.classList.remove("d-none");
				if (ms) setTimeout(() => alertBox.classList.add("d-none"), ms);
			}

			// Reutiliza validaciones: email (mismo criterio que registro/recuperar)
			emailEl.addEventListener("blur", () => {
				setFeedback(
					emailEl,
					emailValido(emailEl.value),
					"Ingresa un correo v√°lido."
				);
			});

			// Para login solo exigimos ‚Äúno vac√≠o‚Äù en password (la complejidad ya se valid√≥ en registro/recuperar)
			passEl.addEventListener("blur", () => {
				const ok = (passEl.value || "").length > 0;
				setFeedback(passEl, ok, "Ingresa tu contrase√±a.");
			});

			// Mostrar/ocultar contrase√±a
			togglePass.addEventListener("click", () => {
				const isPwd = passEl.getAttribute("type") === "password";
				passEl.setAttribute("type", isPwd ? "text" : "password");
				togglePass.textContent = isPwd ? "üôà" : "üëÅÔ∏è";
			});

			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				btn.disabled = true;

				// Validaci√≥n unificada
				const okEmail = emailValido(emailEl.value);
				setFeedback(emailEl, okEmail, "Ingresa un correo v√°lido.");

				const okPass = (passEl.value || "").length > 0;
				setFeedback(passEl, okPass, "Ingresa tu contrase√±a.");

				if (!(okEmail && okPass)) {
					btn.disabled = false;
					return;
				}

				try {
					const user = findUserByEmail((emailEl.value || "").trim());
					if (!user) {
						showAlert("Usuario o contrase√±a inv√°lidos.");
						setFeedback(emailEl, false, "Revisa tu correo.");
						setFeedback(passEl, false, "Revisa tu contrase√±a.");
						btn.disabled = false;
						return;
					}

					const hash = await sha256(passEl.value || "");
					if (hash !== user.passwordHash) {
						showAlert("Usuario o contrase√±a inv√°lidos.");
						setFeedback(passEl, false, "Contrase√±a incorrecta.");
						btn.disabled = false;
						return;
					}

					// Persistir sesi√≥n
					setCurrentUser(user);

					// (Opcional) recordarme
					// if (document.getElementById('recordarme').checked) { localStorage.setItem('remember', '1'); }

					// Redirigir a inicio
					window.location.href = "index.html";
				} catch (err) {
					console.error(err);
					showAlert("Ocurri√≥ un error al iniciar sesi√≥n.");
				} finally {
					btn.disabled = false;
				}
			});
		</script>
	</body>
</html>
